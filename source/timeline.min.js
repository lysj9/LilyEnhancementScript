Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};var TimeLine=function(){var o={body:jq("#timeline"),next:jq("#next"),header:jq("#header"),spinner:jq("#Spinner")};var b={src:"http://zhainan.lightory.net/"};var h={usr:"Warrior",laststamp:"",count:0};var d={item:{d:"",v:0}};var a={};var k=function(t,s){var r=!/\W/.test(t)?_cache[t]=_cache[t]||k(document.getElementById(t).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return s?r(s):r};var i=function(s){var r=+new Date()/1000;var t=r-s;if(t<60){return Math.floor(t)+"秒 前"}else{if(t<3600){return Math.floor(t/60)+"分钟 前"}else{if(t<3600*24){return Math.floor(t/3600)+"小时 前"}else{return new Date(s*1000).format("MM-dd hh:mm")}}}};var g=function(r){if(document.cookie.length>0){c_start=document.cookie.indexOf(r+"=");if(c_start!=-1){c_start=c_start+r.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1){c_end=document.cookie.length}return unescape(document.cookie.substring(c_start,c_end))}}return""};var l=['<li class="<%=direction%>"><i class="pointer"></i><div class="unit">','<div class="storyUnit"><div class="imageUnit">','<div class="imageUnit-content"><h4><a href="#"><%=title%></a></h4><p><%=time%></p></div>','</div><%=content%></div><% if(op!= ""){%><ol class="storyActions">','<li><a href="#"><%=op%></a></li>',"</ol><%}%></div></li>"].join("");var c=function(u,t){var s={direction:(h.count%2==0)?"left":"right",time:i(u[t]["stamp"])};if(/[a-zA-Z_0-9]+\d{10}/.test(u[t]["item"])){var r=/([a-zA-Z_0-9]+)(\d{10})/.exec(u[t]["item"]);s.title=["我觉得 ",r[1]," 版的这个帖子不错"].join("");s.content=(u[t].hasOwnProperty("content")&&u[t]["content"]!="")?u[t]["content"]:"";s.content+="....";s.op=['<a target="_blank" href="../../../bbscon?board=',r[1],"&file=M.",r[2],'.A">帖子正文</a>'].join("")}else{s.title=h.usr;if(u[t]["item"]=="ragnarokthenighttool"){s.content="<p>我觉得 时间轴 挺靠谱</p>";s.op=""}else{s.content=["<p>我觉得 ",u[t]["item"]," 挺靠谱</p>"].join("");s.op=['<a target="_blank" href="../../../bbsqry?userid=',u[t]["item"],'">用户资料</a>'].join("")}}return k(l,s)};var j=function(){if(h.usr==""){return}var r=b.src+"usr?u="+h.usr;jq(window).unbind("scroll.posts");o.spinner.show();if(h.laststamp!=""){r+="&t="+h.laststamp}jq.ajax({url:r,dataType:"jsonp",jsonp:"jsonpcallback",success:function(u){for(var t=0;t<u.length;t++){var s=c(u,t);o.body.append(s);h.count+=1;h.laststamp=u[t]["stamp"]}if(u.length==20){o.spinner.hide();jq(window).bind("scroll.posts",e)}else{o.spinner.html("<p>没有更多的内容啦</p>")}}})};var q=function(t){if(t.d==""){return""}var r=t.d.split(",");if(t.v==1){for(var s=0;s<r.length;s++){if(r[s]==h.usr){r.splice(s,1);break}}switch(r.length){case 0:return"我觉得这个功能还行";case 1:return k("我和 <%=u1%> 都觉得这个功能还行",{u1:r[0]});default:return k('我和其他 <a href="###" onclick="return false;" class="like_style" title="<%=title%>"><%=count%>人</a> 都觉得这个功能还行',{count:r.length,title:t.d})}}switch(r.length){case 0:return"";case 1:return k("<%=u1%> 觉得这个功能还行",{u1:r[0]});case 2:return k("<%=u1%> 和 <%=u2%> 都觉得这个功能还行",{u1:r[0],u2:r[1]});default:return k('<%=u1%> 等 <a href="###" onclick="return false;" class="like_style" title="<%=title%>"><%=count%>人</a> 都觉得这个功能还行',{u1:r[0],count:r.length,title:t.d})}};var p=function(){jq.ajax({url:[b.src,"sgr?u=",h.usr,"&i=ragnarokthenighttool"].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(r){if(r.length>0){d.item=r[0];m()}}})};var m=function(){var r=jq(".like_button:eq(0)");var s=jq(".like_desc:eq(0)");r.show();if(d.item.v==1){r.addClass("liked");r.html('<i class="sp_like"></i>已赞');s.html(q(d.item))}else{r.removeClass("liked");r.html('<i class="sp_like"></i>赞一个');s.html(q(d.item))}};var f=function(u){var r=jq(u);var s="like";if(h.usr==""){return}if(r.hasClass("liked")){s="dislike"}jq.ajax({url:[b.src,"gr?a=",s,"&i=ragnarokthenighttool&u=",h.usr].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(w){if(s=="like"){d.item.v=1;if(d.item.d==""){d.item.d=h.usr}else{var t=d.item.d.split(",");t.push(d.usr);d.item.d=t.join(",")}}else{d.item.v=0;var t=d.item.d.split(",");for(var v=0;v<t.length;v++){if(t[v]==h.usr){t.splice(v,1);break}}d.item.d=t.join(",")}m()}})};var n=function(){h.usr=g("_U_UID");o.spinner.hide();o.header.html(h.usr+" 的时间轴");jq(window).bind("scroll.posts",e);j();p()};var e=function(){var s=jq(window).scrollTop(),t=jq(document).height(),r=jq(window).height();var u=0.95;if((s/(t-r))>u){j()}};return{init:n,togglelike:f}};jq(function(){var a=new TimeLine();a.init();window.tl=a});