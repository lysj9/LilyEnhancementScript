var Colors=new Array("Black","Red","Green","Yellow","Blue","Purple","Indigo");var BColors=new Array("000000","ff0000","008000","ffff00","0000ff","800080","4b0082");var CColors=new Array("","1;31","1;32","1;33","1;34","1;35","1;36");var emotion=[{t:"2.gif",s:"[:s]"},{t:"0.gif",s:"[:O]"},{t:"3.gif",s:"[:|]"},{t:"6.gif",s:"[:$]"},{t:"7.gif",s:"[:X]"},{t:"9.gif",s:"[:'(]"},{t:"10.gif",s:"[:-|]"},{t:"11.gif",s:"[:@]"},{t:"12.gif",s:"[:P]"},{t:"13.gif",s:"[:D]"},{t:"14.gif",s:"[:)]"},{t:"15.gif",s:"[:(]"},{t:"18.gif",s:"[:Q]"},{t:"19.gif",s:"[:T]"},{t:"20.gif",s:"[;P]"},{t:"21.gif",s:"[;-D]"},{t:"26.gif",s:"[:!]"},{t:"27.gif",s:"[:L]"},{t:"32.gif",s:"[:?]"},{t:"16.gif",s:"[:U]"},{t:"25.gif",s:"[:K]"},{t:"29.gif",s:"[:C-]"},{t:"34.gif",s:"[;X]"},{t:"36.gif",s:"[:H]"},{t:"39.gif",s:"[;bye]"},{t:"4.gif",s:"[;cool]"},{t:"40.gif",s:"[:-b]"},{t:"41.gif",s:"[:-8]"},{t:"42.gif",s:"[;PT]"},{t:"43.gif",s:"[;-C]"},{t:"44.gif",s:"[:hx]"},{t:"47.gif",s:"[;K]"},{t:"49.gif",s:"[:E]"},{t:"50.gif",s:"[:-(]"},{t:"51.gif",s:"[;hx]"},{t:"52.gif",s:"[:B]"},{t:"53.gif",s:"[:-v]"},{t:"54.gif",s:"[;xx]"}];var UploadURL="bbsupload?ptext=text&board=FOOD";var FaceURL="/editor/face.htm?ptext=text";var Box=null;var Editor=null;var Conta,Contas;var norep="";var isEditor=false;var Sys={};var ua=navigator.userAgent.toLowerCase();var re=/(msie|firefox|chrome|opera|version).*?([\d.]+)/;var m=ua.match(re);var configs=null;var reply_name="";var user_name="";var reply_borad="";Sys.firefox=m[1].replace(/version/,"'safari")=="firefox";fomt=function(){var b=translate(jq(Editor.document).find("body").html());var a=[];jq("#drag_body .drag_item").each(function(e,d){a.push(jq(d).find(".drag_hidden_url").val());a.push(jq(d).find("textarea").val())});a.push("");b=a.join("\n\r")+b;b=paiban(b);jq("textarea").val(b);jq("textarea").text(jq("textarea").val())};Ret=function(){isEditor=false;jq("tbody").find("tr:eq(3),tr:eq(4),tr:eq(5)").show();Conta.hide();Contas.hide();jq("input[name='autocr']").attr("checked","true");jq("textarea").attr("wrap","hard");fomt()};DiaClose=function(a){Box.remove();Box=null};SelPanel=function(b,f){var a=jq(b).parents(".bBox");a.find(".bBoxTag").removeClass("bBoxTagS");jq(b).addClass("bBoxTagS");a.find(".bBoxCT").hide();a.find(".bBoxCT").eq(f).show()};AddPicture=function(a){AddFilter(jq(a).prev().val())};AddInfo=function(b,a){format("InsertHTML","["+a+"]"+jq(b).prev().val()+"[/"+a+"]")};AddFilter=function(a){a=a.replace(/\n/g,"");if(a.search(/http:\/\/(.*)(?:png|jpg|gif|jpeg)$/i)!=-1){format("InsertImage",a)}else{if(a.search(/http:\/\/(.*)(?:wma)$/i)!=-1){format("InsertHTML","<br>[wma]"+a+"[/wma]")}else{if(a.search(/http:\/\/(.*)(?:swf)$/i)!=-1){format("InsertHTML","<br>[flash]"+a+"[/flash]")}else{format("InsertHTML",a)}}}};function format(b,a){var d=Editor;d.focus();if(!a){d.document.execCommand(b,false,false)}else{d.document.execCommand(b,false,a)}d.focus()}init=function(){isEditor=true;UploadURL=jq("a[href*=bbsupload]").attr("href");var j=jq("textarea").val();var l=j.search(/【 在 (.*?) 的大作中提到: 】/);norep=j.substring(l,j.length);reply_borad=jq("a[href*='board?board=']").text();if(norep!=""){norep.replace(/ ([a-zA-Z0-9]*)? /,function(p,o){reply_name=o;return p});user_name=jq("a[href*='board?board=']").parent("form").text();user_name=user_name.split("").reverse().join("");user_name.replace(/[a-zA-Z0-9]+/i,function(o){user_name=o;return o});user_name=user_name.split("").reverse().join("");if(reply_name!=""&&reply_name!=user_name){var b="";if(configs.send==1){b="checked='true'"}jq("<span style='color:#ff0000'><input type=checkbox id=autoreply "+b+">站内信通知 "+reply_name+"  </span>").insertBefore("input[type=submit]")}}jq("input[name='autocr']").removeAttr("checked");jq("textarea").attr("wrap","soft");jq("head").append("<link rel='stylesheet' type='text/css' href='http://bbs.nju.edu.cn/file/W/Warrior/style.css' />");jq("head").append("<script src='http://bbs.nju.edu.cn/file/W/Warrior/encode.js'><\/script>");jq("tbody").find("tr:eq(3),tr:eq(4),tr:eq(5)").hide();Contas=jq("<tr><td id='drag_body'><div id='drag_container' class='drag_container'>将本地图片从我的电脑或者桌面拖到浏览器中空白位置试试！</div></td></tr>");Contas.insertAfter(jq("tbody tr:eq(5)"));Conta=jq("<tr><td><div id='mF'><div id='mFL' class='bS'></div><div id='mFM'><div id='tB'><div class='btn'><div class='bS bBtn bBold' title='加粗'></div></div><div class='btn'><div class='bS bBtn bColor' more='true' title='文字颜色'></div><div class='BOnColor'></div></div><div class='btn'><div class='bS bBtn bClear' title='清除格式'></div></div><div class='btn'><div class='bS bBtn bSmile' title='添加表情'></div></div><div class='btn'><div class='bS bBtn bPic' title='插入图片'></div></div><div class='btn'><div class='bS bBtn bMusic' title='插入音乐'></div></div><div class='btn'><div class='bS bBtn bFlash' title='插入Flash'></div></div><div class='btn'><div class='bS bBtn bUser' title='链接用户'></div></div><div class='btn'><div class='bS bBtn bBoard' title='链接版面'></div></div><div class='bS bBack'></div></div></div><div id='mFR' class='bS'></div><div id='mFF'><div id='mFFF'></div></div></div></td></tr>");Conta.insertAfter(jq("tbody tr:eq(6)"));var f=jq('<iframe frameborder="0" id="WebEditor" style="height: 320px;width:488px;background:#fff;"></iframe>');jq("#mFFF")[0].appendChild(f[0]);var a=Net.Form.addText;var g=Net.Form.clckcntr;function h(p,o){if(isEditor){if(p=="text"){o=o.replace(/\n/g,"");if(o.indexOf("[")==0){Editor.document.execCommand("insertImage",false,"/images/face/"+findEmotion(o,1,emotion))}else{AddFilter(o)}}else{a(p,o)}Editor.document.focus()}else{a(p,o)}return}var e=function(s){if(!s){return""}var t=[];for(var r=0;r<s.length;r++){var v=s.charAt(r);if(!(/^%u/i.test(escape(v)))){t.push(v);continue}var o=s.charCodeAt(r);var w=o.toString(2).split("");var q=(w.length==15)?[0].concat(w):w;var u=[];u[0]="1110"+q.splice(0,4).join("");u[1]="10"+q.splice(0,6).join("");u[2]="10"+q.splice(0,6).join("");for(var p=0;p<u.length;p++){t.push("%"+parseInt(u[p],2).toString(16).toUpperCase())}}return t.join("")};function k(){if(isEditor){fomt()}if(norep!=""&&reply_name!=""){if(jq("#autoreply")[0].checked){var p=user_name+UrlEncode("回复了您在[")+""+reply_borad+UrlEncode("]版发表的帖子");var o=user_name+UrlEncode("回复了您在[[brd]")+reply_borad+UrlEncode("[/brd]]")+UrlEncode("版发表的帖子:\n\r[")+UrlEncode(jq('input[name="title"]').val())+UrlEncode("]\n\r")+UrlEncode(jq('textarea[name="text"]').val())+"\r\r"+UrlEncode("站内信由百合辅助脚本自动发送 仅作提醒 毋回 谢谢～")+"\r";jq.ajax({type:"POST",async:false,url:"bbssndmail?pid=0&userid=",data:"title="+p+"&userid="+reply_name+"&signature=1&text="+o,success:function(q,r){return}})}}return}Net.Form.addText=h;Net.Form.clckcntr=k;jq(".bBtn").hover(function(){jq(this).addClass("bSelect")},function(){jq(this).removeClass("bSelect")});jq(".bBtn[more='true']").click(function(){releaseAll();jq(this).addClass("bOn").click(releaseAll).next().show()});jq(".bBold").click(function(){format("bold")});jq(".bSmile").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>表情添加</div><div class='bBoxTag' onclick='SelPanel(this,1)' style='color:#ff0000'>兔斯基表情</div></div><div class='bBoxCT'><iframe name=\"fontpanel\" frameborder=\"0\" width=\"100%\" height=\"90\" src=\""+FaceURL+'"/></div><div class=\'bBoxCT\' style=\'display:none\'><iframe name="fontpanel" frameborder="0" width="100%" height="180" src="http://bbs.nju.edu.cn/file/W/Warrior/tusiji.htm"/></div>')});jq(".bClear").click(function(){format("RemoveFormat")});jq(".bPic").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>上传图片</div><div class='bBoxTag' onclick='SelPanel(this,1)'>外网图片</div></div><div class='bBoxCT'><iframe name=\"fontpanel\" frameborder=\"0\" width=\"100%\" height=\"90\" src=\""+UploadURL+"\"/></div><div class='bBoxCT' style='display:none'>JPG,GIF,PNG格式！<input name=exp maxlength=80 size=50><input type=submit value='添加' onClick='AddPicture(this)'></div>")});jq(".bMusic").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>上传音乐</div><div class='bBoxTag' onclick='SelPanel(this,1)'>外网音乐</div></div><div class='bBoxCT'><iframe name=\"fontpanel\" frameborder=\"0\" width=\"100%\" height=\"90\" src=\""+UploadURL+"\"/></div><div class='bBoxCT' style='display:none'>WMA,MP3格式！<input name=exp maxlength=80 size=50><input type=submit value='添加' onClick='AddPicture(this)'></div>")});jq(".bFlash").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>上传Swf</div><div class='bBoxTag' onclick='SelPanel(this,1)'>外网文件</div></div><div class='bBoxCT'><iframe name=\"fontpanel\" frameborder=\"0\" width=\"100%\" height=\"90\" src=\""+UploadURL+"\"/></div><div class='bBoxCT' style='display:none'>SWF格式！<input name=exp maxlength=80 size=50><input type=submit value='添加' onClick='AddPicture(this)'></div>")});jq(".bBack").click(function(){Ret()});jq(".bUser").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>用户ID</div></div><div class='bBoxCT'>输入用户ID！<input name=exp maxlength=80 size=30><input type=submit value='添加' onClick=\"AddInfo(this,'uid')\"></div>")});jq(".bBoard").click(function(){makeDialog("<div class='bBoxTT'><div class='close' onclick='DiaClose(this)'>[关闭面板 X]</div><div class='bBoxTag bBoxTagS' onclick='SelPanel(this,0)'>版面ID</div></div><div class='bBoxCT'>输入版面ID！<input name=exp maxlength=80 size=30><input type=submit value='添加' onClick=\"AddInfo(this,'brd')\"></div>")});for(var d=0;d<Colors.length;d++){var n=jq("<div class='colorBox' style='background:"+Colors[d]+"' cl='"+Colors[d]+"'></div>");jq(".bColor").first().next().append(n);n.click(function(){releaseAll();format("ForeColor",jq(this).attr("cl"))})}Editor=f[0].contentWindow;Editor.document.designMode="on";Editor.document.open();Editor.document.write("<html><head><style type=\"text/css\">*{margin:0;font-size:14px;font-family:宋体;line-height:18px;}</style></head><body topmargin='0px' leftmargin='0' rightmargin='0' bottommargin='0' style='word-wrap:break-word;word-break:break-all;'></body></html>");Editor.document.close()};paiban=function(n){var b=77;var q="iwf";var p=":;cb";var o=0;var j="";var g=0;var k=true;var e=true;var h=true;for(var f=0;f<n.length;f++){if(k&&h&&o>b){j+="\r";o=0}if(n[f]=="["){if(q.indexOf(n[f+1])!=-1){k=false;j+=n[f];g++;f++;e=false}else{if(p.indexOf(n[f+1])!=-1){var a=n[f+1]!="c";while(n[f]!="]"){j+=n[f];if(a){o++}f++}}else{if(n[f+1]=="/"){g--;j+=n[f];f++;e=false}}}}else{if(n[f]=="]"){if(g==0){k=true}e=true}else{if(n[f]=="\n"||n[f]=="\r"){o=0;h=true}else{if(n[f]=="h"&&n[f+1]=="t"&&n[f+2]=="t"&&n[f+3]=="p"){if(f!=0&&n[f-1]!="\r"&&n[f-1]!="]"){j+="\r";o=0}j+="http";f+=4;h=false}else{if(n[f]==" "){h=true}}}}}if(e){o+=(n[f].replace(/[^\x00-\xff]/g,"** ").length>1?2:1)}j+=n[f]}if(!h){j+="\r"}j=j.replace(/\[c=(.*?)\]/gi,function(s,r){r=r.toLowerCase();for(var t=0;t<Colors.length;t++){if(r==Colors[t].toLowerCase()){return"\033["+CColors[t]+"m"}}return s});j=j.replace(/\[\/c\]/gi,"\033[m");if(true){var l=0;var d="";for(var f=0;f<j.length;f++){if(j[f]=="["){d+=j[f];if(j[f+1]=="b"){l=l+1}else{if(j[f+1]=="\\"||j[f+1]=="/"){l=l-1}}f++;d+=j[f]}else{if(j[f]=="\r"){if(l>0){d+="[/b]\r[b]"}else{d+=j[f]}}else{d+=j[f]}}}j=d}j=j.replace(/[\r]*\[\/b\]/gi,"[/b]");j=j.replace(/\[b\]\[\/b\]/gi,"");j=j.replace(/\[img\]/gi,"").replace(/\[\/img\]/gi," ");if(norep!=""){if(configs.reply==0){j+="\n"+norep;return j}if(j.charAt(j.length)==" "||j.charAt(j.length)=="\n"){j=j.substring(0,j.length)}if(o<=48){j+=(" "+norep)}else{j+="\n "+norep}}return j};releaseAll=function(){jq(".bOn").each(function(a){jq(this).next().hide();jq(this).removeClass("bSelect").removeClass("bOn");jq(this).click(function(){releaseAll();jq(this).addClass("bOn").click(releaseAll).next().show()})})};makeDialog=function(a){if(Box!=null){Box.remove()}Box=jq("<div class='bBox'>"+a+"</div>");Box.css("top","30%");Box.css("left","50%");jq("body").append(Box);Box.css("margin-top",-Box[0].offsetHeight/2+"px");Box.css("margin-left",-Box[0].offsetWidth/2+"px");Box.draggable({handle:".bBoxTT"})};translate=function(d){d=d.replace(/&nbsp;/gi," ");d=d.replace(/<img src=\"\/images\/face\/([^\"]*)\">/g,function(g,f){emo=findEmotion(f,0,emotion);if(emo!=f){return emo}return g});d=d.replace(/ = /gi,"=");d=d.replace(/=\"/gi,"=");d=d.replace(/=\'/gi,"=");if(!Sys.firefox){d=d.replace(/<([^ ]*?)span([^<>]*)>/gi,"");d=d.replace(/ style=[^\"]*\"/gi,"")}else{var e=new Array();d=d.replace(/<([^ >]*?)span([^>]*?)>/gi,function(h,g,f){try{if(g=="/"){return e.pop()}else{var k="",j="";if(f.indexOf("bold")!=-1){k+="[b]";j+="[/b]"}if(f.indexOf("color")!=-1){k+="[c="+(f.match(/color: (.*?);/i))[1]+"]";j="[/c]"+j}e.push(j);return k}}catch(l){return h}})}d=d.replace(/<BR>/gi,"\r");d=d.replace(/<BR(.*?)\/>/gi,"\r");d=d.replace(/<P>/gi,"\r");d=d.replace(/<P [^>]*>/gi,"\r");d=d.replace(/<DIV>/gi,"\r");d=d.replace(/<DIV [^>]*>/gi,"\r");d=d.replace(/<IMG[\s\S]*?SRC=([\s\S]*?)\"[\s\S]*?>/gi,"[img]$1[/img]");d=d.replace(/<IMG[\s\S]*?SRC=([\s\S]*?)'[\s\S]*?>/gi,"[img]$1[/img]");d=d.replace(/<BIG>/gi,"[b]");d=d.replace(/<\/BIG>/gi,"[/b]");d=d.replace(/<STRONG>/gi,"[b]");d=d.replace(/<\/STRONG>/gi,"[/b]");d=d.replace(/<B>/gi,"[b]");d=d.replace(/<\/B>/gi,"[/b]");d=d.replace(/<FONT(.*?)color=/gi,"[c=");d=d.replace(/ STYLE=[^\'\">]*[\'\">]/gi,"");d=d.replace(/ color=/gi,"][c=");d=d.replace(/<\/FONT>/gi,"[/c]");d=d.replace(/<TR[^>]*>/gi,"\r");d=d.replace(/<TD[^>]*>/gi," ");d=d.replace(/<TH[^>]*>/gi," ");d=d.replace(/<\/TR>/gi," ");d=d.replace(/<\/TD>/gi," ");d=d.replace(/<\/TH>/gi," ");d=d.replace(/<[^>]*>/g,"");d=d.replace(/;\">/g,"]");d=d.replace(/>/g,"]");d=d.replace(/\'>/g,"]");d=d.replace(/\">/g,"]");d=d.replace(/\']/g,"]");d=d.replace(/\"]/g,"]");if(Sys.firefox){var a=new Array();var b="";d=d.replace(/\[([^c]{0,1})c(.*?)\]/gi,function(h,g,f){if(g=="/"){if(a.length>0){h+=a.pop()}else{b=""}return h}else{var j=h;if(b!=""||a.length!=0){j="[/c]"+j}if(b!=""){a.push(b)}b=h;return j}});d=d.replace(/\[c=([^\]]*?)\]\[\/c\]/gi,"");d=d.replace(/<\/SPAN>/gi,"[/c]")}d=d.replace(/\[c(.*?)\]/gi,function(g,f){if(f.indexOf("#")==-1){return g}else{f=f.toLowerCase();for(var h=0;h<BColors.length;h++){if(f.indexOf(BColors[h])!=-1){return"[c="+Colors[h]+"]"}}return g}});return d};function findEmotion(d,a,b){if(a==1){for(i=0;i<b.length;i++){if(b[i].s==d){return b[i].t}}}else{for(i=0;i<b.length;i++){if(b[i].t==d){return b[i].s}}}return d}var DragClass=function(){var k={body:jq("#drag_body"),container:jq("#drag_container"),hand:jq(document.body)};var h=[];var d=0;var b=false;var a=function(p){p.preventDefault();var l=p.dataTransfer.files;if(l.length==0){return}for(var n=0,o;o=l[n];n++){if(l[n].type.indexOf("image")===-1){continue}h.push(l[n])}if(!b){f()}};var f=function(){b=true;if(d>=h.length){b=false;return}var l=new FileReader();var o=d;d++;var p=jq('<div class="drag_item" id="'+d+'"><input type="hidden" class="drag_hidden_url"/><img src="" width=80 height=80/><textarea placeholder="在这里输入对图片的描述" class="drag_text"></textarea><div class="drag_right_ctrl"><p><span class="drag_status">[上传中]</span></p><span><a href="###" onclick="return mbbs_drag.deletes(this);">[删除]</a></span></div></div>');p.insertBefore(k.container);l.onload=function(q){p.find("img")[0].src=this.result};xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){var r=xhr.responseText.replace(/[\n\r]/ig,"");var q=/url=([^\']*)/ig.exec(r);if(q){jq.get(q[1],function(t){t=t.replace(/[\n\r]/ig,"");var s=/name=([^\']*)/ig.exec(t);if(s){p.find(".drag_hidden_url").val("http://bbs.nju.edu.cn/file/"+reply_borad+"/"+s[1]);p.find(".drag_status").html('<a href="http://bbs.nju.edu.cn/file/'+reply_borad+"/"+s[1]+'" target=_blank>[预览]</a>')}else{p.find(".drag_status").text("上传失败！")}})}else{p.find(".drag_status").text("上传失败！")}}else{}};xhr.open("post","bbsdoupload",true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.addEventListener("load",function(q){f()},false);var n=new FormData();n.append("up",h[o]);n.append("exp","");n.append("ptext","");n.append("board",reply_borad);l.readAsDataURL(h[o]);xhr.send(n)};var g=function(l){};var j=function(){k.hand[0].addEventListener("dragenter",function(l){l.preventDefault()},false);k.hand[0].addEventListener("dragleave",function(l){g(l)},false);k.hand[0].addEventListener("dragover",function(l){l.preventDefault()},false);k.hand[0].addEventListener("drop",function(l){a(l)},false);k.body.sortable({items:".drag_item"})};var e=function(l){jq(l).parents(".drag_item").remove()};return{init:j,deletes:e}};var post_init=function(){c=_g("m_configs");configs=jq.extend({},{gender:1,menu:1,reply:1,send:0},eval(c!=""?"("+c+")":""));init();dg=new DragClass();dg.init();window.mbbs_drag=dg};post_init();