var BBSViwer=function(){var E={posts:jq("table.main")};var g={gender:1,menu:1,src:"http://zhainan.lightory.net/",nextpage:false};var f={posts:[],tids:{},base:0,userdesc:{},ips:{},baseurl:"",read_count:30,board:""};var w=function(J){var I=[],H=_g("d_"+J);if(H!=""){I=H.split(",")}return I};var r=function(J,K){var I=[],H=_g("d_"+J);if(H==""){_s("d_"+J,K)}else{I=H.split(",");I.push(K);I=_unique(I);_s("d_"+J,I.join(","))}};var C=function(I,J){var H=_getcookie("_U_UID");if(H==""){H="guest"}jq.ajax({url:[g.src,"gp?u=",H,"&d=",encodeURI(J),"&k=",I].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(K){}})};var s=function(I,H){jq.ajax({url:[g.src,"d?d=",encodeURI(H),"&k=",I].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(J){}})};var j=function(){jq(E.posts).each(function(I,K){var H=f.posts[I].uname;if(jq(K).attr("usdone")!="1"&&f.userdesc.hasOwnProperty(H)&&f.userdesc[H]!=""){var L=f.userdesc[H].split(",");for(var J=0;J<L.length;J++){if(jq(K).find("a[tgn='"+L[J]+"']").size()==0){jq(['<a class="mDec mTag" href="javascript:;" title="网络上别人共享的标签" tgn="',L[J],'">',L[J],"</a>"].join("")).insertBefore(jq(K).find(".mAdd"))}}jq(K).attr("usdone","1")}})};var z=function(M,L){var K=[],J=_g("d_"+M);if(J==""){return}else{K=J.split(",");var H=[];for(var I=0;I<K.length;I++){if(K[I]==L){continue}H.push(K[I])}_s("d_"+M,H.join(","))}};var d=function(I,H){if(H>=I.length){j();return}jq.ajax({url:g.src+"gd?ip="+I.slice(H,30).join("-"),dataType:"jsonp",jsonp:"jsonpcallback",success:function(K){for(var J=0;J<K.length;J++){f.userdesc[K[J]["u"]]=K[J]["d"]}d(I,H+30)}})};var c=function(){jq(E.posts).each(function(H,I){var K=f.posts[H].ip;if(jq(I).attr("ipdone")!="1"&&f.ips.hasOwnProperty(K)&&f.ips[K].length>""){var J=jq(I).find("tr:eq(0) .mOp:eq(0)");jq('<a class="mDec" href="javascript:;" title="'+f.ips[K].join(" ")+'">'+f.ips[K][0]+"</a>").insertBefore(J);jq(I).attr("ipdone","1")}})};var b=function(H,I){if(I>=H.length){c();return}jq.ajax({url:g.src+"?ip="+H.slice(I,30).join("o"),dataType:"jsonp",jsonp:"jsonpcallback",success:function(L){var K=0,J=0;for(K=I;J<L.length&&K<H.length;K++,J++){f.ips[H[K]]=new Array(decodeURI(L[J].c),decodeURI(L[J].a))}b(H,I+30)}})};var a=function(L,K){if(L.d==""){return""}var H=L.d.split(",");var I=_getcookie("_U_UID");if(L.v==1){for(var J=0;J<H.length;J++){if(H[J]==I){H.splice(J,1);break}}switch(H.length){case 0:return _tmpl("我觉得<%=type%>不错",{type:K==0?"这篇帖子":"这个回复"});case 1:return _tmpl("我和 <%=u1%> 觉得<%=type%>不错",{u1:H[0],type:K==0?"这篇帖子":"这个回复"});default:return _tmpl('我和其他 <a href="###" onclick="return false;" class="like_style" title="<%=title%>"><%=count%>人</a> 觉得<%=type%>不错',{count:H.length,type:K==0?"这篇帖子":"这个回复",title:L.d})}}switch(H.length){case 0:return"";case 1:return _tmpl("<%=u1%> 觉得<%=type%>不错",{u1:H[0],type:K==0?"这篇帖子":"这个回复"});case 2:return _tmpl("<%=u1%> 和 <%=u2%> 觉得<%=type%>不错",{u1:H[0],u2:H[1],type:K==0?"这篇帖子":"这个回复"});default:return _tmpl('<%=u1%> 等 <a href="###" onclick="return false;" class="like_style" title="<%=title%>"><%=count%>人</a> 觉得<%=type%>不错',{u1:H[0],count:H.length,type:K==0?"这篇帖子":"这个回复",title:L.d})}};var D=function(){var H=['<span class="like_button <% if(liked==1){ %>liked<% } %>" onclick="mbbs.togglelike(this)" >','<i class="sp_like"></i><% if(liked==1){ %>已赞<% }else{ %>赞一个<% } %></span>','<span class="like_desc"><%=desc%></span>'].join("");jq(E.posts).each(function(I,K){var L=f.posts[I].tid;if(jq(K).attr("tiddone")!="1"&&f.tids.hasOwnProperty(L)&&f.tids[L]!=""){var J=f.tids[L];var M=jq(K).find("tr:eq(1) td:eq(0)");M.append(_tmpl(H,{desc:a(J,f.posts[I]["floor"]),liked:J.v}));jq(K).attr("tiddone","1")}})};var m=function(I,J){if(J>=I.length){D();return}var H=_getcookie("_U_UID");jq.ajax({url:[g.src,"sgr?b=",f.board,"&u=",H,"&i=",I.slice(J,30).join("*")].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(M){var L=0,K=0;for(L=J;K<M.length&&L<I.length;L++,K++){f.tids[I[L]]=M[K]}m(I,J+30)}})};var l=function(H){var J=[];var I=w(H);J.push("<tr><td colspan=2>");J.push('<span style="float:right">');J.push('<a class="mDec mOp" href="javascript:;" onClick="mbbs.highlight(this)">跟踪</a>');J.push('<a class="mDec mOp" href="javascript:;" onClick="mbbs.toggle(this)">折叠</a>');J.push('<a class="mDec mGender" href="javascript:;" onclick="mbbs.getgender(this)"> ?</a>');J.push("</span>");jq(I).each(function(K,L){J.push('<a class="mDec mTag" href="javascript:;" title="我添加的标签" onClick="mbbs.deltag(this)" tgn="');J.push(L);J.push('">');J.push(L);J.push(" X</a>")});J.push('<a class="mDec mAdd" href="javascript:;"" onClick="mbbs.addtag(this)">添加标签</a>');J.push("</td></tr>");return J.join("")};var y=function(K,L){var J=[];var I=[];var H=[];jq(K).each(function(O,P){var W=jq(P);var U=jq.trim(W.text()).split("\n");var M=/\[FROM: ([\d\.]*)\]/ig.exec(U[U.length-1]);var Q=parseInt(jq.trim(W.find("td[align=right]").text()));var V=jq.trim(W.find("tr td a:eq(2)").text());var R=M?M[1]:false;var N=jq.trim(W.find("tr td a:eq(1)").attr("href"));var T=/board=([^&]+)&file=M.([\d]+).A/.exec(N);if(T&&T.length==3){N=T[2];f.board=T[1]}else{N=""}O=O+L;if(O==0){f.base=Q;f.read_count=f.base+30}f.posts.push({uname:V,floor:Q,ip:R?R:"888.888.888.888",tid:N});if(!f.userdesc.hasOwnProperty(V)){J.push(V);f.userdesc[V]=""}if(R&&!f.ips.hasOwnProperty(R)){I.push(R);f.ips[R]=new Array()}if(N&&!f.tids.hasOwnProperty(N)){H.push(N);f.tids[N]=""}var S=W.find("tr:eq(0) td:eq(0)");S.html(S.html().replace(/本篇(作者|人气)/g,"$1"));W.prepend(l(V));W.attr("fid",O)});I=_unique(I);J=_unique(J);H=_unique(H);d(J,0);b(I,0);m(H,0)};var B=function(){var H=_QueryString();f.baseurl=["bbstcon?board=",H.board,"&file=",H.file,"&start="].join("");jq.extend(g,jq.parseJSON(_g("m_configs")));y(E.posts,0);G(f.posts[0].uname);var I=['<style type="text/css">',"a.mDec {background:#eee;border-radius:3px;display:inline-block;font-size:12px;color:#700B97;border:0;margin-right:10px;padding:4px;}a.mDec:hover{color:#ff0000;}a.mAdd{color:#666;}a.mOp{}a.mLine{background:#eee;color:#666;}a.mTag{color:#A02482}a.mGender{background: #E088BD;color: white;margin:0;}a.mGender.GG{background: #9389FF}a.mGender.XD{background: #B3B3B3}",".like_desc{margin-left:5px;}",".like_button{margin-left:5px;background: #ECEEF5;border-radius: 3px;border: 1px solid #CAD4E7;cursor: pointer;padding: 2px 2px 2px;white-space: nowrap;color: #3B5998;}",".like_button:hover{border-color:#9dacce}",".like_button.liked{background-color: #EEE;border-color: #DDD;color: #AAA;}",".sp_like{background-image:url(http://bbs.nju.edu.cn/file/W/Warrior/like.png);background-repeat:no-repeat;display:inline-block;height:14px;width:14px;background-position: -0px -45px;position: relative;top: 3px;margin-right: 3px;}",".like_button.liked:hover{border-color:#ccc}",".like_desc a.like_style{color:#3D6CBE}",".like_button.liked .sp_like{background-position: -0px -15px;}",".like_button.liked:hover .sp_like{background-position: -0px -30px;}","</style>"].join("");jq("head").append(I);e();jq(E.posts).each(function(J,K){jq(K).find("img").each(function(L,M){if(parseInt(jq(M).css("width"))>600){jq(M).css("width","600px")}})});A(jq(document.body).html());p()};var x=function(H){var I=jq(H).parents("table").find("pre").toggle()};var e=function(I){var J=I?jq(I).parents("table"):jq(E.posts[0]);var K=parseInt(J.attr("fid"));var H=f.posts[K].uname;jq(E.posts).each(function(L,M){jq(M).css("border",f.posts[L].uname==H?"2px solid #8CC0F8":"2px solid #d0f0c0")})};var i=function(I){var J=jq(I).parents("table");var K=parseInt(J.attr("fid"));var H=f.posts[K].uname;Net.Dialog.show("请给 "+H+" 增加一个描述把！","<form name=forms onSubmit=\"return false\" ><input placeholder='input here' type='text' value='' id='mbbs_tags' /><input type='submit' value='Submit' onclick=\"mbbs.addtagsubmit('"+H+"')\"/><br/><br/><span style='color:#666666'><input type='checkbox' id='mbbs_updatenet' checked />共享</span></form>");jq("#mbbs_tags").focus()};var k=function(I){u=jq.trim(jq("#mbbs_tags").val());if(u==null||u==""){Net.Dialog.close();return false}r(I,u);var H=['<a class="mDec mTag" href="javascript:;" onClick="mbbs.deltag(this)" tgn="',u,'">',u," X</a>"].join("");for(var J=0;J<f.posts.length;J++){if(f.posts[J]["uname"]==I){jq(H).insertBefore(jq(E.posts[J]).find(".mAdd"))}}if(jq("#mbbs_updatenet")[0].checked){C(I,u)}Net.Dialog.close();return false};var q=function(K){var L=jq(K).parents("table");var M=parseInt(L.attr("fid"));var H=f.posts[M].uname;var J=jq(K).text();J=J.substr(1,J.length-4);z(H,J);s(H,J);for(var I=0;I<f.posts.length;I++){if(f.posts[I]["uname"]==H){jq(E.posts[I]).find("a[tgn='"+J+"']").remove()}}};var h=function(I){var H=_getcookie("_U_UID");var K=I.parents("table");var L=parseInt(K.attr("fid"));var J=f.posts[L].tid;if(H==""){alert("匆匆过客不能顶哦!请先登录~");return}if(J!=""){jq.ajax({url:[g.src,"gr?a=like&i=",f.board,J,"&u=",H].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(N){if(f.tids[J]["d"]==""){f.tids[J]["d"]=H}else{var M=f.tids[J]["d"].split(",");M.push(H);f.tids[J]["d"]=M.join(",")}f.tids[J]["v"]=1;v(J)}})}};var v=function(I){var H=f.tids[I];console.log(H);jq(E.posts).each(function(J,L){if(f.posts[J]["tid"]==I){var K=a(H,f.posts[J]["floor"]);if(H.v==1){jq(L).find(".like_button").addClass("liked").html('<i class="sp_like"></i>已赞')}else{jq(L).find(".like_button").removeClass("liked").html('<i class="sp_like"></i>赞一个')}jq(L).find(".like_desc").html(K)}})};var n=function(I){var H=_getcookie("_U_UID");var K=I.parents("table");var L=parseInt(K.attr("fid"));var J=f.posts[L].tid;if(H==""){alert("您还没登录呢~");return}if(J!=""){jq.ajax({url:[g.src,"gr?a=dislike&i=",f.board,J,"&u=",H].join(""),dataType:"jsonp",jsonp:"jsonpcallback",success:function(O){var M=f.tids[J]["d"].split(",");var P=[];for(var N=0;N<M.length;N++){if(M[N]==H||M[N]==""){}else{P.push(M[N])}}f.tids[J]["d"]=P.join(",");f.tids[J]["v"]=0;v(J)}})}};var t=function(I){var H=jq(I);if(H.hasClass("liked")){n(H)}else{h(H)}};var A=function(J){J=J.replace(/&amp;/g,"&");var I=f.baseurl+f.read_count;var H=J.indexOf(I);if(H>0){g.nextpage=true}else{g.nextpage=false}};var p=function(){if(g.nextpage){jq.get(f.baseurl+f.read_count,function(L){var H=f.read_count;f.read_count+=30;A(L);L=L.split("\n");var K=L.slice(5,L.length-4);var I=/Net.Html.make\((\d+)\)/ig.exec(K[K.length-1]);if(I){K[K.length-1]="</textarea></table><hr color=white><script>Net.Html.make("+I[1]+")<\/script>"}else{K[K.length-1]=""}K[0]="<table width=610 class=main><tr>";var M=jq("<div>"+K.join("\n")+"</div>");M.insertAfter(jq("center:eq(0) table").last());var J=[];M.find("table").each(function(O,N){if(O==0){return}J.push(N);E.posts.push(N)});M.find("table:eq(0)").remove();y(J,H+1);setTimeout(function(){p()},3000)})}};var F=function(H,J){var I="http://bbs.nju.edu.cn/bbsqry?userid="+H;jq.get(I,function(L){var M="XD";try{M=(L.match(/\[1\;[0-9]{2}m(.*)\[m\]/g))[0].match(/[0-9]{2}/g)}catch(K){}J&&J(H,M=="35"?"MM":(M=="36"?"GG":"XD"))})};var G=function(H){F(H,function(I,J){jq(E.posts).each(function(K,L){if(f.posts[K].uname==I){jq(L).find("tr:eq(0) a.mGender").attr("onclick","").addClass(J).html(J)}})})};var o=function(J){var I=jq(J);var K=I.parents("table");var L=parseInt(K.attr("fid"));var H=f.posts[L].uname;I.attr("onclick","");G(H)};return{init:B,toggle:x,togglelike:t,highlight:e,addtag:i,deltag:q,addtagsubmit:k,getgender:o}};var view_init=function(){bbs=new BBSViwer();bbs.init();window.mbbs=bbs};view_init();